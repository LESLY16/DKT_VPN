name: Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read

jobs:
  # ── Linux ──────────────────────────────────────────────────────────────────
  build-linux:
    name: Build (Linux)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Qt 6
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.7.*'
          modules: ''
          cache: true

      - name: Install WireGuard tools
        run: sudo apt-get install -y wireguard-tools

      - name: Configure
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build --config Release --parallel

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: DKT_VPN-linux
          path: build/DKT_VPN
          if-no-files-found: error

  # ── macOS ──────────────────────────────────────────────────────────────────
  build-macos:
    name: Build (macOS)
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Qt 6
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.7.*'
          modules: ''
          cache: true

      - name: Install WireGuard tools
        run: brew install wireguard-tools

      - name: Configure
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build --config Release --parallel

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: DKT_VPN-macos
          path: build/DKT_VPN.app
          if-no-files-found: error

  # ── Windows ────────────────────────────────────────────────────────────────
  build-windows:
    name: Build (Windows)
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Qt 6
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.7.*'
          arch: 'win64_msvc2019_64'
          modules: ''
          cache: true

      - name: Configure (MSVC)
        run: cmake -B build -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build --config Release --parallel

      - name: Deploy Qt (windeployqt)
        shell: pwsh
        run: |
          & "$env:Qt6_BIN_DIR\windeployqt.exe" "build\Release\DKT_VPN.exe" --release --no-translations

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: DKT_VPN-windows
          path: build/Release/
          if-no-files-found: error
